var webview;

fun getWebview() {
    if (webview != null && !webview.disposed) {
        return webview;
    }

    return AsyncTask.resolve(
        () => Webview.create(),
        onDone: fun (res) {
            webview = res;
            return webview;
        }
    );
}

fun getSite(url, [waitUntil = 'domContentLoaded']) {
    return AsyncTask.resolve(
        () => getWebview(),
        onDone: fun (webview) {
            return AsyncTask.resolve(
                () => webview.open(url, waitUntil),
                onDone: fun (_) {
                    return AsyncTask.resolve(
                        () => webview.tryBypassCloudfareBrowserVerification(),
                        onDone: fun (bypassed) {
                            if (!bypassed) throw 'Failed to bypass cloudflare';

                            return webview;
                        }
                    );
                }
            );
        }
    );
}